FROM node:16-alpine AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app
COPY package.json package-lock.json ./
RUN npm install --frozen-lockfile

FROM node:16-alpine AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .

ARG ENVIRONMENT
ENV ENVIRONMENT ${ENVIRONMENT}

ARG NEXT_PUBLIC_ENVIRONMENT
ENV NEXT_PUBLIC_ENVIRONMENT ${NEXT_PUBLIC_ENVIRONMENT}

ARG DB_CONNECTION_STRING
ENV DB_CONNECTION_STRING ${DB_CONNECTION_STRING}

ARG NEXT_PUBLIC_GOOGLE_ANALYTICS
ENV NEXT_PUBLIC_GOOGLE_ANALYTICS ${NEXT_PUBLIC_GOOGLE_ANALYTICS}

ARG NEXT_PUBLIC_API_KEY
ENV NEXT_PUBLIC_API_KEY ${NEXT_PUBLIC_API_KEY}

ARG NEXT_PUBLIC_FIREBASE_DATABASE_URL
ENV NEXT_PUBLIC_FIREBASE_DATABASE_URL ${NEXT_PUBLIC_FIREBASE_DATABASE_URL}

ARG NEXT_PUBLIC_ROLLBAR_ACCESS_TOKEN
ENV NEXT_PUBLIC_ROLLBAR_ACCESS_TOKEN ${NEXT_PUBLIC_ROLLBAR_ACCESS_TOKEN}

ARG NEXT_PUBLIC_ROLLBAR_ENVIRONMENT
ENV NEXT_PUBLIC_ROLLBAR_ENVIRONMENT ${NEXT_PUBLIC_ROLLBAR_ENVIRONMENT}

ARG FIREBASE_PROJECT_ID
ENV FIREBASE_PROJECT_ID ${FIREBASE_PROJECT_ID}

ARG FIREBASE_AUTH_DOMAIN
ENV FIREBASE_AUTH_DOMAIN ${FIREBASE_AUTH_DOMAIN}

ARG FIREBASE_CLIENT_EMAIL
ENV FIREBASE_CLIENT_EMAIL ${FIREBASE_CLIENT_EMAIL}

ARG FIREBASE_MESSAGING_SENDER_ID
ENV FIREBASE_MESSAGING_SENDER_ID ${FIREBASE_MESSAGING_SENDER_ID}

ARG FIREBASE_APP_ID
ENV FIREBASE_APP_ID ${FIREBASE_APP_ID}

ARG FIREBASE_MEASUREMENT_ID
ENV FIREBASE_MEASUREMENT_ID ${FIREBASE_MEASUREMENT_ID}

ARG FIREBASE_COOKIE_SECRET_PREVIOUS
ENV FIREBASE_COOKIE_SECRET_PREVIOUS ${FIREBASE_COOKIE_SECRET_PREVIOUS}

ARG FIREBASE_COOKIE_SECRET_CURRENT
ENV FIREBASE_COOKIE_SECRET_CURRENT ${FIREBASE_COOKIE_SECRET_CURRENT}

ARG TWITCH_CLIENT_ID
ENV TWITCH_CLIENT_ID ${TWITCH_CLIENT_ID}

ARG TWITCH_SECRET
ENV TWITCH_SECRET ${TWITCH_SECRET}

ARG NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
ENV NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY ${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY}

ARG STRIPE_SECRET_KEY
ENV STRIPE_SECRET_KEY ${STRIPE_SECRET_KEY}

ARG STRIPE_WEBHOOK_SECRET
ENV STRIPE_WEBHOOK_SECRET ${STRIPE_WEBHOOK_SECRET}

ARG SUBSCRIPTION_PRICE_ID
ENV SUBSCRIPTION_PRICE_ID ${SUBSCRIPTION_PRICE_ID}

ARG MONTHLY_TIP_PRICE_ID
ENV MONTHLY_TIP_PRICE_ID ${MONTHLY_TIP_PRICE_ID}

ARG NEXT_PUBLIC_SOCKET_HOST
ENV NEXT_PUBLIC_SOCKET_HOST ${NEXT_PUBLIC_SOCKET_HOST}

ARG GOOGLE_APPLICATION_CREDENTIALS
ENV GOOGLE_APPLICATION_CREDENTIALS ${GOOGLE_APPLICATION_CREDENTIALS}

RUN npm run build

# Production image
# Copy files from builder and run next
FROM node:16-alpine AS runner
WORKDIR /app

ENV NODE_ENV production

RUN addgroup -g 1001 -S nodejs
RUN adduser -S nextjs -u 1001

COPY --from=builder /app/next.config.js ./
COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next ./.next
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./package.json

EXPOSE 3000

ENV PORT 3000

CMD [ "npm", "run", "serve" ]